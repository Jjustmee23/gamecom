name: Deploy to VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
        
    - name: Add VPS to known hosts
      run: |
        ssh-keyscan -H 45.154.238.116 >> ~/.ssh/known_hosts
        
    - name: Deploy to VPS
      run: |
        ssh ${{ secrets.VPS_USER }}@45.154.238.116 << 'EOF'
          echo "ğŸš€ Starting deployment..."
          
          # Navigate to application directory
          cd /opt/gamecom
          
          # Configure git with token for private repository access
          git config --global credential.helper store
          echo "https://Jjustmee23:${{ secrets.GITHUB_TOKEN }}@github.com" > ~/.git-credentials
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes..."
          git pull origin main
          
          # Stop current containers
          echo "ğŸ›‘ Stopping current containers..."
          docker compose down
          
          # Rebuild and start containers
          echo "ğŸ”¨ Rebuilding containers..."
          docker compose up --build -d
          
          # Run database migrations if needed
          echo "ğŸ—„ï¸ Running database migrations..."
          docker compose exec -T backend npm run db:migrate || echo "No migrations needed"
          
          # Check deployment status
          echo "âœ… Checking deployment status..."
          docker compose ps
          
          echo "ğŸ‰ Deployment completed successfully!"
        EOF
        
    - name: Verify deployment
      run: |
        # Wait a moment for containers to start
        sleep 30
        
        # Check if application is responding
        curl -f https://com.midaweb.be/health || echo "Health check failed, but deployment might still be successful"
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Deployment successful! Application is live at https://com.midaweb.be"
        else
          echo "âŒ Deployment failed. Check the logs above for details."
        fi 